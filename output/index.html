<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python UX Application</title>
    <script src="pyodide/pyodide.js"></script>
    
    <!-- CodeMirror CSS and JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        #loading {
            text-align: center;
            padding: 50px;
        }
        #content {
            max-width: 1200px;
            margin: 0 auto;
            display: none;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <p>Loading Python environment...</p>
    </div>
    
    <div id="content"></div>

    <script>
        async function initializeApp() {
            try {
                // Initialize Pyodide with local installation
                const pyodide = await loadPyodide({
                    indexURL: "./pyodide/"
                });
                
                // Install required packages
                await pyodide.loadPackage(['micropip']);
                
                // Load and mount py_html module files
                const pyHtmlFiles = ['py_html/environment.py', 'py_html/elements.py', 'py_html/setup.py', 'py_html/css.py', 'py_html/__init__.py', 'py_html/styles/framework.py', 'py_html/styles/__init__.py', 'py_html/macros/custom_layouts.py', 'py_html/macros/ui.py', 'py_html/macros/custom_examples.py', 'py_html/macros/components.py', 'py_html/macros/examples.py', 'py_html/macros/custom_ui.py', 'py_html/macros/__init__.py', 'py_html/macros/layouts.py', 'py_html/macros/forms.py', 'py_html/macros/custom_forms.py'];
                
                // Load and mount py_dom module files
                const pyDomFiles = ['py_dom/events.py', 'py_dom/__init__.py'];
                
                // Create py_html module structure in Pyodide
                pyodide.FS.mkdir('/py_html');
                pyodide.FS.mkdir('/py_html/macros');
                pyodide.FS.mkdir('/py_html/styles');
                
                // Create py_dom module structure in Pyodide
                pyodide.FS.mkdir('/py_dom');
                
                // Create scripts module structure in Pyodide
                pyodide.FS.mkdir('/scripts');
                
                // Create additional directories dynamically
                const additionalDirs = ['/scripts/ui', '/scripts/ui/applets'];
                for (const dir of additionalDirs) {
                    try {
                        pyodide.FS.mkdir(dir);
                        console.log(`Created directory: ${dir}`);
                    } catch (error) {
                        console.warn(`Could not create directory ${dir}:`, error);
                    }
                }
                
                // Load each py_html file
                for (const file of pyHtmlFiles) {
                    try {
                        const response = await fetch(file);
                        const content = await response.text();
                        pyodide.FS.writeFile(`/${file}`, content);
                        console.log(`Loaded ${file}`);
                    } catch (error) {
                        console.warn(`Could not load ${file}:`, error);
                    }
                }
                
                // Load each py_dom file
                for (const file of pyDomFiles) {
                    try {
                        const response = await fetch(file);
                        const content = await response.text();
                        pyodide.FS.writeFile(`/${file}`, content);
                        console.log(`Loaded ${file}`);
                    } catch (error) {
                        console.warn(`Could not load ${file}:`, error);
                    }
                }
                
                // Load Python files from scripts folder
                const pythonFiles = ['scripts/include.py', 'scripts/sci_ux_components.py', 'scripts/main.py', 'scripts/__init__.py', 'scripts/home.py', 'scripts/file_explorer_demo.py', 'scripts/text_editor_demo.py', 'scripts/about.py', 'scripts/ui/skeleton.py', 'scripts/ui/__init__.py', 'scripts/ui/modal.py', 'scripts/ui/applets/terminal.py', 'scripts/ui/applets/data_table.py', 'scripts/ui/applets/maps.py', 'scripts/ui/applets/text_editor.py', 'scripts/ui/applets/file_explorer.py', 'scripts/ui/applets/outputs.py', 'scripts/ui/applets/__init__.py'];
                for (const file of pythonFiles) {
                    try {
                        const response = await fetch(file);
                        const content = await response.text();
                        pyodide.FS.writeFile(`/${file}`, content);
                        console.log(`Loaded ${file}`);
                    } catch (error) {
                        console.warn(`Could not load ${file}:`, error);
                    }
                }
                
                // Add py_html, py_dom and scripts to Python path
                let pythonPathSetup = `
                    import sys
                    sys.path.insert(0, '/py_html')
                    sys.path.insert(0, '/py_dom')
                    sys.path.insert(0, '/scripts')`;
                
                // Add additional directories to Python path
                for (const dir of additionalDirs) {
                    pythonPathSetup += `
                    sys.path.insert(0, '${dir}')`;
                }
                
                pythonPathSetup += `
                    sys.path.insert(0, '/')
                    print("Python path updated with py_html, py_dom and scripts (including detected subdirectories)")
                `;
                
                await pyodide.runPython(pythonPathSetup);
                
                // Look for and execute main.py from scripts folder or current directory
                let mainScript = null;
                if (pythonFiles.includes('scripts/main.py')) {
                    mainScript = 'scripts/main.py';
                } else if (pythonFiles.includes('main.py')) {
                    mainScript = 'main.py';
                }
                
                if (mainScript) {
                    const response = await fetch(mainScript);
                    const mainCode = await response.text();
                    await pyodide.runPython(mainCode);
                    console.log(`Executed ${mainScript}`);
                }
                
                // Hide loading and show content
                const loadingElement = document.getElementById('loading');
                const contentElement = document.getElementById('content');
                
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                if (contentElement) {
                    contentElement.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading Pyodide:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: red;">Error loading application: ${error.message}</p>
                `;
            }
        }
        
        // Start loading when page is ready
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>